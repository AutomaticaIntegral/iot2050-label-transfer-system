<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Impresoras - TCP Label Transfer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        /* Estilos de login */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(44, 62, 80, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .login-form {
            background: white;
            padding: 3rem;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-header h1 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .login-header p {
            color: #666;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .login-btn {
            width: 100%;
            background: #3498db;
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s;
        }

        .login-btn:hover {
            background: #2980b9;
        }

        .error-message {
            color: #e74c3c;
            margin-top: 1rem;
            text-align: center;
            display: none;
        }

        /* Estilos principales */
        .hidden {
            display: none !important;
        }

        .header {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .status {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #fff;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: auto;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #27ae60;
        }

        .stat-label {
            color: #666;
            margin-top: 0.5rem;
        }

        .section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .section-header {
            padding: 1rem 2rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .refresh-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .refresh-btn:hover {
            background: #229954;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            font-size: 0.9rem;
            color: #666;
        }

        td {
            font-size: 0.9rem;
        }

        .file-id {
            font-family: 'Monaco', 'Menlo', monospace;
            background: #f1f3f4;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.8rem;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-printer {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .badge-success {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-right: 0.5rem;
        }

        .btn-view {
            background: #e3f2fd;
            color: #1976d2;
        }

        .btn-download {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .btn:hover {
            opacity: 0.8;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 2rem;
            color: #e74c3c;
            background: #fdf2f2;
            border-radius: 4px;
            margin: 1rem;
        }

        .empty {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .zpl-content {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
            word-break: break-all;
            border: 1px solid #ddd;
        }

        /* Estilos para impresoras */
        .printers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            padding: 1rem 2rem;
        }

        .printer-card {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .printer-card.online {
            border-color: #27ae60;
            background: #e8f5e8;
        }

        .printer-card.offline {
            border-color: #e74c3c;
            background: #fdf2f2;
        }

        .printer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .printer-name {
            font-weight: 600;
            font-size: 1rem;
        }

        .printer-status {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .printer-status.online {
            background: #27ae60;
            color: white;
        }

        .printer-status.offline {
            background: #e74c3c;
            color: white;
        }

        .printer-details {
            font-size: 0.8rem;
            color: #666;
            line-height: 1.4;
        }

        .printer-detail {
            margin-bottom: 0.25rem;
        }

        /* Estilos para filtros */
        .filters-section {
            background: #f8f9fa;
            padding: 1rem 2rem;
            border-bottom: 1px solid #eee;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #666;
            margin-bottom: 0.25rem;
        }

        .filter-input {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .filter-actions {
            display: flex;
            gap: 0.5rem;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .filter-btn.apply {
            background: #3498db;
            color: white;
        }

        .filter-btn.clear {
            background: #95a5a6;
            color: white;
        }

        .filter-btn:hover {
            opacity: 0.8;
        }

        /* Estilos para configuración de impresoras */
        .config-btn {
            background: #f39c12;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 0.5rem;
        }

        .config-btn:hover {
            background: #e67e22;
        }

        .config-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .config-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #eee;
        }

        .config-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .config-close {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .config-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }

        .printer-config-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border-left: 4px solid #3498db;
        }

        .printer-config-title {
            font-weight: 600;
            margin-bottom: 1rem;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .config-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .config-field {
            display: flex;
            flex-direction: column;
        }

        .config-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #555;
            margin-bottom: 0.5rem;
        }

        .config-input {
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .config-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .config-input.error {
            border-color: #e74c3c;
        }

        .config-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }

        .config-save-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
        }

        .config-save-btn:hover {
            background: #229954;
        }

        .config-save-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .config-cancel-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
        }

        .config-cancel-btn:hover {
            background: #7f8c8d;
        }

        .config-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .config-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
            
            .stats {
                grid-template-columns: 1fr 1fr;
            }
            
            .section-header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }

            .status {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Login Overlay -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-form">
            <div class="login-header">
                <h1>🖨️ Monitor de Impresoras</h1>
                <p>Acceso restringido - Ingrese credenciales</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Usuario</label>
                    <input type="text" id="username" name="username" required autofocus placeholder="admin">
                </div>
                <div class="form-group">
                    <label for="password">Contraseña</label>
                    <input type="password" id="password" name="password" required placeholder="admin123">
                </div>
                <button type="submit" class="login-btn">Iniciar Sesión</button>
                <div id="loginError" class="error-message">
                    Usuario o contraseña incorrectos
                </div>
            </form>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
        <div class="header">
            <h1>🖨️ Monitor de Impresoras - TCP Label Transfer</h1>
            <div class="status">
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>Impresoras Online</span>
                </div>
                <div class="status-item">
                    <span>ZPL Files</span>
                </div>
                <div class="status-item">
                    <span id="lastUpdate">Actualizando...</span>
                </div>
                <button class="logout-btn" onclick="logout()">🚪 Cerrar Sesión</button>
            </div>
        </div>

        <div class="container">
            <!-- Información de Impresoras -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title">🖨️ Estado de Impresoras</div>
                    <div>
                        <button class="refresh-btn" onclick="loadPrintersInfo()">🔄 Verificar</button>
                        <button class="config-btn" onclick="openPrintersConfig()">⚙️ Configurar</button>
                    </div>
                </div>
                <div id="printersInfo" class="printers-grid">
                    <div class="loading">Cargando información de impresoras...</div>
                </div>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalFiles">-</div>
                    <div class="stat-label">Archivos Enviados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayFiles">-</div>
                    <div class="stat-label">Enviados Hoy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSize">-</div>
                    <div class="stat-label">Tamaño Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgSize">-</div>
                    <div class="stat-label">Tamaño Promedio</div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <div class="section-title">📄 Archivos ZPL Enviados a Impresoras</div>
                    <button class="refresh-btn" onclick="loadPrinterFiles()">🔄 Actualizar</button>
                </div>
                
                <!-- Filtros -->
                <div class="filters-section">
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label class="filter-label">🗓️ Fecha Desde</label>
                            <input type="date" id="dateFrom" class="filter-input">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">🗓️ Fecha Hasta</label>
                            <input type="date" id="dateTo" class="filter-input">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">🏷️ Tipo de Etiqueta</label>
                            <select id="labelTypeFilter" class="filter-input">
                                <option value="">Todos los tipos</option>
                                <option value="normal">🏷️ Normales (Bidón)</option>
                                <option value="rfid">📡 RFID (IBC)</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">📏 Tamaño</label>
                            <select id="sizeFilter" class="filter-input">
                                <option value="">Todos los tamaños</option>
                                <option value="small">< 1 KB</option>
                                <option value="medium">1-5 KB</option>
                                <option value="large">> 5 KB</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">🔍 Buscar ID</label>
                            <input type="text" id="searchId" placeholder="ID del archivo..." class="filter-input">
                        </div>
                        <div class="filter-actions">
                            <button class="filter-btn apply" onclick="applyFilters()">🔍 Filtrar</button>
                            <button class="filter-btn clear" onclick="clearFilters()">🗑️ Limpiar</button>
                        </div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                                            <th>ID Archivo</th>
                            <th>Timestamp</th>
                            <th>Tipo Etiqueta</th>
                            <th>Tamaño</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="printerFilesTable">
                            <tr>
                                <td colspan="6" class="loading">Cargando archivos ZPL...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para ver contenido ZPL -->
    <div id="zplModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">📄 Contenido ZPL</div>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalFileName" style="font-weight: 600; margin-bottom: 1rem;"></div>
            <div id="zplContent" class="zpl-content">Cargando...</div>
        </div>
    </div>

    <!-- Modal para configuración de impresoras -->
    <div id="configModal" class="config-modal hidden">
        <div class="config-content">
            <div class="config-header">
                <div class="config-title">⚙️ Configuración de Impresoras</div>
                <button class="config-close" onclick="closePrintersConfig()">&times;</button>
            </div>
            
            <div class="config-warning">
                <strong>⚠️ ADVERTENCIA:</strong> Cambiar estas configuraciones afectará el envío de etiquetas a las impresoras. 
                Asegúrese de que las direcciones IP sean correctas y que las impresoras estén accesibles. 
                Se requiere reiniciar el servicio para aplicar los cambios.
            </div>

            <div id="configMessage"></div>

            <div class="printer-config-section">
                <div class="printer-config-title">
                    🏷️ Impresora de Producto (Etiquetas Normales)
                </div>
                <div class="config-form-row">
                    <div class="config-field">
                        <label class="config-label">Dirección IP</label>
                        <input type="text" id="productPrinterIP" class="config-input" 
                               placeholder="10.108.220.10" pattern="^(\d{1,3}\.){3}\d{1,3}$|^localhost$">
                    </div>
                    <div class="config-field">
                        <label class="config-label">Puerto</label>
                        <input type="number" id="productPrinterPort" class="config-input" 
                               placeholder="9100" min="1" max="65535">
                    </div>
                </div>
            </div>

            <div class="printer-config-section">
                <div class="printer-config-title">
                    📡 Impresora RFID (Etiquetas IBC)
                </div>
                <div class="config-form-row">
                    <div class="config-field">
                        <label class="config-label">Dirección IP</label>
                        <input type="text" id="rfidPrinterIP" class="config-input" 
                               placeholder="10.108.220.15" pattern="^(\d{1,3}\.){3}\d{1,3}$|^localhost$">
                    </div>
                    <div class="config-field">
                        <label class="config-label">Puerto</label>
                        <input type="number" id="rfidPrinterPort" class="config-input" 
                               placeholder="9100" min="1" max="65535">
                    </div>
                </div>
            </div>

            <div class="config-actions">
                <button class="config-cancel-btn" onclick="closePrintersConfig()">❌ Cancelar</button>
                <button class="config-save-btn" id="saveConfigBtn" onclick="savePrintersConfig()">💾 Guardar Configuración</button>
            </div>
        </div>
    </div>

    <script>
        let printerFiles = [];
        let filteredFiles = [];
        let printersInfo = {};
        let isAuthenticated = false;
        let autoRefresh = true;
        
        // Prevenir inicialización múltiple
        let autoRefreshStarted = false;
        let listenersSetup = false;
        let currentFilters = {
            dateFrom: '',
            dateTo: '',
            labelTypeFilter: '',
            sizeFilter: '',
            searchId: ''
        };

        // Autenticación básica
        function login(username, password) {
            return username === 'admin' && password === 'admin123';
        }

        function checkAuth() {
            const authData = sessionStorage.getItem('printerMonitorAuth');
            if (authData) {
                try {
                    const auth = JSON.parse(authData);
                    if (auth.authenticated && auth.timestamp > Date.now() - (4 * 60 * 60 * 1000)) { // 4 horas
                        return true;
                    }
                } catch (e) {
                    // Error parsing, remove invalid data
                    sessionStorage.removeItem('printerMonitorAuth');
                }
            }
            return false;
        }

        function setAuth() {
            sessionStorage.setItem('printerMonitorAuth', JSON.stringify({
                authenticated: true,
                timestamp: Date.now()
            }));
        }

        function logout() {
            sessionStorage.removeItem('printerMonitorAuth');
            document.getElementById('loginOverlay').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            isAuthenticated = false;
        }

        // Función para cargar información de impresoras
        async function loadPrintersInfo() {
            if (!isAuthenticated) return;

            try {
                const response = await fetch('/api/printers-info');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                printersInfo = await response.json();
                renderPrintersInfo();
                
            } catch (error) {
                console.error('Error cargando información de impresoras:', error);
                const container = document.getElementById('printersInfo');
                container.innerHTML = `<div class="error">Error al cargar impresoras: ${error.message}</div>`;
            }
        }

        // Función para renderizar información de impresoras
        function renderPrintersInfo() {
            const container = document.getElementById('printersInfo');
            
            const printersHtml = Object.entries(printersInfo).map(([key, printer]) => `
                <div class="printer-card ${printer.status}">
                    <div class="printer-header">
                        <div class="printer-name">${printer.name}</div>
                        <div class="printer-status ${printer.status}">${printer.status}</div>
                    </div>
                    <div class="printer-details">
                        <div class="printer-detail"><strong>Dirección:</strong> ${printer.host}:${printer.port}</div>
                        <div class="printer-detail"><strong>Tipo:</strong> ${printer.type}</div>
                        <div class="printer-detail"><strong>Descripción:</strong> ${printer.description}</div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = printersHtml;
        }

        // Funciones de filtros
        function applyFilters() {
            currentFilters.dateFrom = document.getElementById('dateFrom').value;
            currentFilters.dateTo = document.getElementById('dateTo').value;
            currentFilters.labelTypeFilter = document.getElementById('labelTypeFilter').value;
            currentFilters.sizeFilter = document.getElementById('sizeFilter').value;
            currentFilters.searchId = document.getElementById('searchId').value.toLowerCase();

            filteredFiles = printerFiles.filter(file => {
                // Filtro por fecha
                if (currentFilters.dateFrom || currentFilters.dateTo) {
                    const fileDate = new Date(file.timestamp).toISOString().split('T')[0];
                    
                    if (currentFilters.dateFrom && fileDate < currentFilters.dateFrom) {
                        return false;
                    }
                    
                    if (currentFilters.dateTo && fileDate > currentFilters.dateTo) {
                        return false;
                    }
                }

                // Filtro por tipo de etiqueta
                if (currentFilters.labelTypeFilter) {
                    const fileType = file.labelType || 'normal';
                    if (fileType !== currentFilters.labelTypeFilter) {
                        return false;
                    }
                }

                // Filtro por tamaño
                if (currentFilters.sizeFilter) {
                    const sizeKB = file.size / 1024;
                    switch (currentFilters.sizeFilter) {
                        case 'small':
                            if (sizeKB >= 1) return false;
                            break;
                        case 'medium':
                            if (sizeKB < 1 || sizeKB > 5) return false;
                            break;
                        case 'large':
                            if (sizeKB <= 5) return false;
                            break;
                    }
                }

                // Filtro por ID
                if (currentFilters.searchId && !file.id.toLowerCase().includes(currentFilters.searchId)) {
                    return false;
                }

                return true;
            });

            updateStats();
            renderFiles();
        }

        function clearFilters() {
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('labelTypeFilter').value = '';
            document.getElementById('sizeFilter').value = '';
            document.getElementById('searchId').value = '';
            
            currentFilters = {
                dateFrom: '',
                dateTo: '',
                labelTypeFilter: '',
                sizeFilter: '',
                searchId: ''
            };

            filteredFiles = [...printerFiles];
            updateStats();
            renderFiles();
        }

        // Función para cargar archivos de impresora
        async function loadPrinterFiles() {
            if (!isAuthenticated) return;

            try {
                console.log('Cargando archivos ZPL...');
                const response = await fetch('/api/printer-files');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                printerFiles = await response.json();
                console.log('Archivos ZPL cargados:', printerFiles.length);
                
                // Aplicar filtros si están activos
                if (Object.values(currentFilters).some(f => f !== '')) {
                    applyFilters();
                } else {
                    filteredFiles = [...printerFiles];
                }
                
                updateStats();
                renderFiles();
                updateLastUpdate();
                
            } catch (error) {
                console.error('Error cargando archivos ZPL:', error);
                showError(`Error al cargar archivos: ${error.message}`);
            }
        }

        // Función para actualizar estadísticas
        function updateStats() {
            // Usar siempre filteredFiles
            const total = filteredFiles.length;
            
            // Archivos de hoy
            const today = new Date().toDateString();
            const todayCount = filteredFiles.filter(f => 
                new Date(f.timestamp).toDateString() === today
            ).length;
            
            // Tamaño total y promedio
            const totalBytes = filteredFiles.reduce((sum, f) => sum + f.size, 0);
            const avgBytes = total > 0 ? totalBytes / total : 0;

            document.getElementById('totalFiles').textContent = total;
            document.getElementById('todayFiles').textContent = todayCount;
            document.getElementById('totalSize').textContent = formatSize(totalBytes);
            document.getElementById('avgSize').textContent = formatSize(avgBytes);
        }

        // Función para renderizar tabla de archivos
        function renderFiles() {
            const tbody = document.getElementById('printerFilesTable');
            
            // Usar siempre filteredFiles. Si no hay filtros aplicados, filteredFiles = printerFiles
            if (filteredFiles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty">No hay archivos ZPL que coincidan con los filtros</td></tr>';
                return;
            }

            tbody.innerHTML = filteredFiles.slice(0, 50).map(file => {
                // Formatear timestamp
                let timestamp = '-';
                try {
                    if (file.timestamp) {
                        const date = new Date(file.timestamp);
                        if (!isNaN(date.getTime())) {
                            timestamp = date.toLocaleString('es-ES');
                        }
                    }
                } catch (e) {
                    timestamp = '-';
                }

                // Determinar tipo y color de badge
                const labelType = file.labelType || 'normal';
                const isRfid = labelType === 'rfid';
                const typeBadge = isRfid ? 
                    '<span class="badge" style="background: #fff3e0; color: #f57c00;">📡 RFID</span>' : 
                    '<span class="badge" style="background: #e3f2fd; color: #1976d2;">🏷️ Normal</span>';
                
                return `
                    <tr>
                        <td><span class="file-id">${file.id}</span></td>
                        <td>${timestamp}</td>
                        <td>${typeBadge}</td>
                        <td>${formatSize(file.size)}</td>
                        <td><span class="badge badge-success">Enviado</span></td>
                        <td>
                            <button class="btn btn-view" onclick="viewFile('${file.id}')">👁 Ver</button>
                            <button class="btn btn-download" onclick="downloadFile('${file.id}')">📥 Descargar</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Función para mostrar errores
        function showError(message) {
            const tbody = document.getElementById('printerFilesTable');
            tbody.innerHTML = `<tr><td colspan="6" class="error">${message}</td></tr>`;
        }

        // Función para actualizar timestamp
        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                `Actualizado: ${now.toLocaleTimeString('es-ES')}`;
        }

        // Función para formatear tamaños
        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // Función para ver archivo ZPL
        async function viewFile(fileId) {
            try {
                const response = await fetch(`/api/printer-files/${fileId}`);
                if (!response.ok) {
                    throw new Error('Error al cargar archivo');
                }
                
                const fileData = await response.json();
                
                document.getElementById('modalFileName').textContent = fileData.filename;
                document.getElementById('zplContent').textContent = fileData.content;
                document.getElementById('zplModal').classList.remove('hidden');
            } catch (error) {
                alert(`Error al cargar archivo: ${error.message}`);
            }
        }

        // Función para descargar archivo
        function downloadFile(fileId) {
            const file = printerFiles.find(f => f.id === fileId);
            if (file) {
                // Crear enlace temporal para descarga
                const link = document.createElement('a');
                link.href = `data:text/plain;charset=utf-8,${encodeURIComponent('Ver archivo: ' + file.filename)}`;
                link.download = file.filename;
                link.click();
            }
        }

        // Función para cerrar modal
        function closeModal() {
            document.getElementById('zplModal').classList.add('hidden');
        }

        // Funciones para configuración de impresoras
        function openPrintersConfig() {
            // Cargar configuración actual
            if (printersInfo.product && printersInfo.rfid) {
                document.getElementById('productPrinterIP').value = printersInfo.product.host;
                document.getElementById('productPrinterPort').value = printersInfo.product.port;
                document.getElementById('rfidPrinterIP').value = printersInfo.rfid.host;
                document.getElementById('rfidPrinterPort').value = printersInfo.rfid.port;
            }
            
            // Limpiar mensajes
            document.getElementById('configMessage').innerHTML = '';
            
            // Mostrar modal
            document.getElementById('configModal').classList.remove('hidden');
        }

        function closePrintersConfig() {
            document.getElementById('configModal').classList.add('hidden');
        }

        function validateIP(ip) {
            if (ip === 'localhost') return true;
            const ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
            if (!ipRegex.test(ip)) return false;
            
            const parts = ip.split('.');
            return parts.every(part => {
                const num = parseInt(part, 10);
                return num >= 0 && num <= 255;
            });
        }

        function validatePort(port) {
            const portNum = parseInt(port, 10);
            return portNum >= 1 && portNum <= 65535;
        }

        function showConfigMessage(message, type = 'error') {
            const messageDiv = document.getElementById('configMessage');
            messageDiv.className = `config-${type}`;
            messageDiv.innerHTML = message;
        }

        async function savePrintersConfig() {
            const productIP = document.getElementById('productPrinterIP').value.trim();
            const productPort = document.getElementById('productPrinterPort').value.trim();
            const rfidIP = document.getElementById('rfidPrinterIP').value.trim();
            const rfidPort = document.getElementById('rfidPrinterPort').value.trim();

            // Limpiar clases de error
            document.querySelectorAll('.config-input').forEach(input => {
                input.classList.remove('error');
            });

            // Validaciones
            let hasErrors = false;

            if (!productIP || !validateIP(productIP)) {
                document.getElementById('productPrinterIP').classList.add('error');
                hasErrors = true;
            }

            if (!productPort || !validatePort(productPort)) {
                document.getElementById('productPrinterPort').classList.add('error');
                hasErrors = true;
            }

            if (!rfidIP || !validateIP(rfidIP)) {
                document.getElementById('rfidPrinterIP').classList.add('error');
                hasErrors = true;
            }

            if (!rfidPort || !validatePort(rfidPort)) {
                document.getElementById('rfidPrinterPort').classList.add('error');
                hasErrors = true;
            }

            if (hasErrors) {
                showConfigMessage('❌ Por favor, corrija los errores en los campos marcados en rojo.', 'error');
                return;
            }

            // Deshabilitar botón durante el guardado
            const saveBtn = document.getElementById('saveConfigBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = '💾 Guardando...';

            try {
                const response = await fetch('/api/printers-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        productPrinter: {
                            host: productIP,
                            port: parseInt(productPort, 10)
                        },
                        rfidPrinter: {
                            host: rfidIP,
                            port: parseInt(rfidPort, 10)
                        }
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showConfigMessage('✅ Configuración guardada correctamente. ⚠️ Reinicie el servicio para aplicar los cambios.', 'success');
                    
                    // Actualizar información de impresoras
                    setTimeout(() => {
                        loadPrintersInfo();
                    }, 1000);
                    
                } else {
                    showConfigMessage(`❌ Error: ${result.error}`, 'error');
                }

            } catch (error) {
                showConfigMessage(`❌ Error de conexión: ${error.message}`, 'error');
            } finally {
                // Rehabilitar botón
                saveBtn.disabled = false;
                saveBtn.textContent = '💾 Guardar Configuración';
            }
        }

        // Auto-refresh cada 15 segundos (con protección contra duplicación)
        function startAutoRefresh() {
            if (autoRefreshStarted) {
                console.log('Auto-refresh ya iniciado, evitando duplicación');
                return;
            }
            
            autoRefreshStarted = true;
            console.log('Iniciando auto-refresh único cada 15 segundos');
            
            setInterval(() => {
                if (autoRefresh && isAuthenticated) {
                    loadPrintersInfo();
                    loadPrinterFiles();
                }
            }, 15000);
        }

        // Event listeners
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (login(username, password)) {
                setAuth();
                isAuthenticated = true;
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                document.getElementById('loginError').style.display = 'none';
                loadPrintersInfo();
                loadPrinterFiles();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        });

        // Cerrar modales con ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
                closePrintersConfig();
            }
        });

        // Auto-login desde dashboard principal
        function checkAutoLogin() {
            const autoLogin = sessionStorage.getItem('autoLogin');
            if (autoLogin) {
                try {
                    const credentials = JSON.parse(autoLogin);
                    const now = Date.now();
                    
                    // Verificar que las credenciales no sean muy viejas (5 minutos)
                    if (now - credentials.timestamp < 300000) {
                        if (credentials.username === 'admin' && credentials.password === 'admin123') {
                            setAuth();
                            return true;
                        }
                    }
                } catch (error) {
                    console.log('Error parsing auto-login credentials');
                }
                // Limpiar credenciales inválidas o expiradas
                sessionStorage.removeItem('autoLogin');
            }
            return false;
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Monitor de Impresoras iniciado');
            
            // Intentar auto-login primero
            if (checkAutoLogin() || checkAuth()) {
                isAuthenticated = true;
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                loadPrintersInfo();
                loadPrinterFiles();
            }
            
            startAutoRefresh();
            
            // Agregar event listeners para filtros automáticos
            setupFilterListeners();
        });

        // Configurar event listeners para filtros automáticos (con protección contra duplicación)
        function setupFilterListeners() {
            if (listenersSetup) {
                console.log('Event listeners ya configurados, evitando duplicación');
                return;
            }
            
            listenersSetup = true;
            console.log('Configurando event listeners únicos para filtros');
            
            // Filtros de fecha
            document.getElementById('dateFrom').addEventListener('change', applyFilters);
            document.getElementById('dateTo').addEventListener('change', applyFilters);
            
            // Filtro de tipo de etiqueta
            document.getElementById('labelTypeFilter').addEventListener('change', applyFilters);
            
            // Filtro de tamaño
            document.getElementById('sizeFilter').addEventListener('change', applyFilters);
            
            // Búsqueda por ID (con pequeño delay para evitar filtrar en cada tecla)
            let searchTimeout;
            document.getElementById('searchId').addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(applyFilters, 300);
            });
        }

        // Manejar errores globales
        window.addEventListener('error', function(e) {
            console.error('Error global:', e.error);
        });
    </script>
    
    <!-- Footer discreto -->
    <div style="position: fixed; bottom: 10px; right: 15px; font-size: 0.7rem; color: #95a5a6; background: rgba(255,255,255,0.8); padding: 0.3rem 0.6rem; border-radius: 4px; z-index: 1000;">
        Desarrollado por <strong>Automática Integral</strong>
    </div>
</body>
</html> 